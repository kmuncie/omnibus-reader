window.module=function(){"use strict";var getPromise,promises={};return getPromise=function(name){return promises[name]||(promises[name]=new $.Deferred),promises[name]},{define:function(name,obj){getPromise(name).resolve(obj)},require:function(deps,fn){var p=_.map(deps,getPromise);$.when.apply($,p).then(fn)}}}(),module.require(["Controller","fetcher"],function(Controller,fetcher){"use strict";var controller,doc=$(document);doc.ready(function(){doc.foundation()}),controller=new Controller(fetcher),controller.addView(),$(".colorMode").click(function(){$(".entirePage").toggleClass("darkMode"),$(".colorMode").toggleClass("lightButton")}),$("#addNew").click(function(){controller.addView()})}),module.require(["template"],function(template){"use strict";var Controller;Controller=function(fetcher,template){var self=this;this.fetcher=fetcher,this.template=template,this.viewCount=0,this.singleView=!0,this.books=[],this.fetcher.listBooks().then(function(books){self.books=books})},Controller.prototype.addView=function(){var view=this.__getView(),context=this.__buildContext(view);$("#content").append(view),this.viewCount++,this.singleView=1===this.viewCount,rivets.bind(view,context),this.fetcher.listBooks().then(function(){context.view.find(".sel-book").change()})},Controller.prototype.changeBook=function(e,c){e.preventDefault();var book,count,i;for(book=_.find(c.controller.books,function(b){return b.bookNum===c.state.book}),count=parseInt(book.chapterCount,10),c.state.chapters=[],i=0;count>i;i++)c.state.chapters.push({chapterNum:i+1});c.view.find(".sel-chapter").change()},Controller.prototype.changeChapter=function(e,c){e.preventDefault(),c.state.isLoading=!0,c.controller.fetcher.getChapter(c.state.book,c.state.chapter).then(function(chap){c.state.title=chap.citation,c.state.content=chap.html,c.state.isLoading=!1}),c.state.isLastChapter=c.state.book>=c.controller.books.length&&c.state.chapter>=c.state.chapters.length},Controller.prototype.changeSize=function(e,c){var icon=c.view.find(".iconResize");return c.view.hasClass("medium-8 large-4")?void c.view.removeClass("large-4"):c.view.hasClass("medium-8")&&c.state.isExpanding?(c.view.removeClass("medium-8"),icon.removeClass("icon-expand"),icon.addClass("icon-contract"),void(c.state.isExpanding=!1)):(c.view.hasClass("medium-8")&&(c.view.addClass("large-4"),c.state.isExpanding=!0),c.view.addClass("medium-8"),void(c.state.isExpanding?(icon.addClass("icon-expand"),icon.removeClass("icon-contract")):(icon.removeClass("icon-expand"),icon.addClass("icon-contract"))))},Controller.prototype.destroyView=function(e,c){e.preventDefault(),c.controller.viewCount--,c.controller.singleView=1===c.controller.viewCount,c.view.remove()},Controller.prototype.nextChapter=function(e,c){e.preventDefault(),c.state.chapter>=c.state.chapters.length?(c.state.chapter=1,c.state.book++):c.state.chapter++,c.controller.changeChapter(e,c)},Controller.prototype.__buildContext=function(view){var context={view:view,controller:this,state:{isLoading:!0,isExpanding:!0,isLastChapter:!1,book:1,chapter:1,chapters:[],title:null,content:null}};return context},Controller.prototype.__getView=function(){return template.clone()},module.define("Controller",Controller)}),function(){"use strict";var DEBUG=!1;module.define("debug",{log:function(obj){DEBUG&&console.log(obj)}})}(),module.require(["debug"],function(debug){"use strict";var BasicFetcher,IndexedDBFetcher;window.indexedDB||(window.indexedDB=window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB),window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction,window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange,BasicFetcher=function(){},BasicFetcher.prototype={BASE_URL:"http://www.jw.org/en/publications/bible/nwt/books/json/",getChapter:function(bid,cid){var range=this.__getRangeID(bid,cid),url="html/"+range;return this.__makeRequest(url).then(function(d){var chapter=d.ranges[Object.keys(d.ranges)[0]];return chapter.range=range,chapter})},listBooks:function(){return this.__makeRequest("").then(function(data){var book,num,books=[];for(num in data.editionData.books)data.editionData.books.hasOwnProperty(num)&&(book=data.editionData.books[num],book.bookNum=parseInt(num,10),book.chapterCount=parseInt(book.chapterCount,10),books.push(book));return books})},__getRangeID:function(bid,cid){var bcid=("00"+bid).slice(-2)+("00"+cid).slice(-3),range=bcid+"001-"+bcid+"999";return range},__makeRequest:function(){var cache={};return function(path){return path=this.BASE_URL+path+"?callback=?",cache.hasOwnProperty(path)||(debug.log("Requesting "+path),cache[path]=$.getJSON(path),cache[path].done(function(){debug.log("Response "+path)})),cache[path]}}()},IndexedDBFetcher=function(){var gettingDB=new $.Deferred,request=window.indexedDB.open(this.DATABASE,this.VERSION);request.onerror=function(event){gettingDB.reject(),window.alert("Could not open IndexedDB connection. Error: "+event.target.errorCode)},request.onsuccess=function(){gettingDB.resolve(request.result)},request.onupgradeneeded=function(event){var db=event.target.result,bookStore=db.createObjectStore("books",{keyPath:"bookNum"}),chapterStore=db.createObjectStore("chapters",{keyPath:"range"});bookStore.createIndex("urlSegment","urlSegment",{unique:!0}),chapterStore.createIndex("validRange","validRange",{unique:!0})},this.gettingDB=gettingDB,this.__fillCache()},IndexedDBFetcher.prototype=new BasicFetcher,IndexedDBFetcher.prototype.DATABASE="BibleFetcher",IndexedDBFetcher.prototype.VERSION=1,IndexedDBFetcher.prototype.getChapter=function(bid,cid){var range=this.__getRangeID(bid,cid),getting=new $.Deferred,self=this;return this.__getByKey("chapters",range).done(function(chapter){getting.resolve(chapter)}).fail(function(){self.__fillChapter(range).then(function(){return self.getChapter(bid,cid)}).then(function(chapter){getting.resolve(chapter)})}),getting},IndexedDBFetcher.prototype.listBooks=function(){var listing=this.__listObjectStore("books"),self=this;return listing=listing.then(function(books){return 0===books.length?self.__fillBookStore().then(function(){return self.listBooks()}):books})},IndexedDBFetcher.prototype.__fillBookStore=function(){var listing,self=this;return listing=this.__makeRequest("").then(function(data){return data.editionData.books}),listing.then(function(books){var bookNums=Object.keys(books);!function insert(bookNum){var book=books[bookNum];book.bookNum=parseInt(bookNum,10),self.__insert("books",book).then(function(){bookNums.length&&insert(bookNums.shift())})}(bookNums.shift())})},IndexedDBFetcher.prototype.__fillCache=function(){var self=this;this.listBooks().then(function(books){!function load(i,j){var book=books[i],numChapters=parseInt(book.chapterCount,10);self.getChapter(book.bookNum,j).then(function(){numChapters>j?j++:(i++,j=1),i<books.length&&setTimeout(function(){load(i,j)},50)})}(0,1)})},IndexedDBFetcher.prototype.__fillChapter=function(range){var url="html/"+range,self=this;return this.__makeRequest(url).then(function(d){var chapter=d.ranges[Object.keys(d.ranges)[0]];return chapter.range=range,self.__insert("chapters",chapter)})},IndexedDBFetcher.prototype.__getByKey=function(name,key){var getting=new $.Deferred;return this.__getObjectStore(name).then(function(store){var request=store.get(key);request.onsuccess=function(e){var result=e.target.result;return void 0!==result?(debug.log("Found key "+key+" in "+name+" ObjectStore"),void getting.resolve(e.target.result)):(debug.log("Found nothing for key "+key+" in "+name+" ObjectStore"),void getting.reject())}}),getting},IndexedDBFetcher.prototype.__getObjectStore=function(name){return this.gettingDB.then(function(db){var transaction=db.transaction([name],"readwrite"),store=transaction.objectStore(name);return store})},IndexedDBFetcher.prototype.__getRangeID=function(bid,cid){var bcid=("00"+bid).slice(-2)+("00"+cid).slice(-3),range=bcid+"001-"+bcid+"999";return range},IndexedDBFetcher.prototype.__insert=function(name,obj){return this.__getObjectStore(name).then(function(store){store.add(obj)})},IndexedDBFetcher.prototype.__listObjectStore=function(name,keyRange){var listing=new $.Deferred;return keyRange=keyRange||window.IDBKeyRange.lowerBound(0),this.__getObjectStore(name).then(function(store){var cursorRequest=store.openCursor(keyRange),set=[];cursorRequest.onsuccess=function(e){var cursor=e.target.result;return cursor?(set.push(cursor.value),void cursor.continue()):(debug.log("Found "+set.length+" rows in "+name+" ObjectStore"),void listing.resolve(set))}}),listing},module.define("fetcher",function(){return window.indexedDB?new IndexedDBFetcher:new BasicFetcher}())}),function(){"use strict";$.get("template.html").then(function(html){html=$(html),module.define("template",html)})}();