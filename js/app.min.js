window.module=function(){"use strict";var getPromise,promises={};return getPromise=function(name){return promises[name]||(promises[name]=new $.Deferred),promises[name]},{define:function(name,obj){getPromise(name).resolve(obj)},require:function(deps,fn){var p=_.map(deps,getPromise);$.when.apply($,p).then(fn)}}}(),module.require(["Controller","fetcher"],function(Controller,fetcher){"use strict";var controller,doc=$(document);doc.ready(function(){doc.foundation()}),controller=new Controller(fetcher),controller.addView(),$(".colorMode").click(function(){$(".entirePage").toggleClass("darkMode"),$(".colorMode").toggleClass("lightButton")}),$("#addNew").click(function(){controller.addView()})}),module.require(["template"],function(template){"use strict";var Controller;Controller=function(fetcher,template){var self=this;this.fetcher=fetcher,this.template=template,this.viewCount=0,this.singleView=!0,this.languages=[],this.fetcher.listLanguages().then(function(languages){self.languages=languages})},Controller.prototype.addView=function(){var self=this;this.fetcher.listLanguages().then(function(){var view=self.__getView(),context=self.__buildContext(view);$("#content").append(view),self.viewCount++,self.singleView=1===self.viewCount,rivets.bind(view,context),context.state.edition="http://www.jw.org/en/publications/bible/nwt/books/json/",context.view.find(".sel-lang").change()})},Controller.prototype.changeBook=function(e,c){e.preventDefault();var book,count,i,bookID=parseInt(c.state.book,10);for(book=_.find(c.state.books,function(b){return b.bookNum===bookID})||_.first(c.state.books),c.state.book=book.bookNum,count=parseInt(book.chapterCount,10),c.state.chapters=[],i=0;count>i;i++)c.state.chapters.push({chapterNum:i+1});c.state.chapter=1,c.view.find(".sel-chapter").change()},Controller.prototype.changeChapter=function(e,c){e.preventDefault(),c.state.isLoading=!0,c.controller.fetcher.getChapter(c.state.edition,c.state.book,c.state.chapter).then(function(chap){c.state.title=chap.citation,c.state.content=chap.html,c.state.isLoading=!1}),c.state.isLastChapter=c.state.book>=c.state.books.length&&c.state.chapter>=c.state.chapters.length},Controller.prototype.showLang=function(e,c){e.preventDefault(),c.view.find(".langContainer").toggleClass("visible")},Controller.prototype.changeLanguage=function(e,c){e.preventDefault(),c.state.isLoading=!0,c.controller.fetcher.listBooks(c.state.edition).then(function(books){c.state.isLoading=!1,c.state.books=books,c.view.find(".sel-book").change()})},Controller.prototype.changeSize=function(e,c){var icon=c.view.find(".iconResize");return c.view.hasClass("medium-8 large-4")?void c.view.removeClass("large-4"):c.view.hasClass("medium-8")&&c.state.isExpanding?(c.view.removeClass("medium-8"),icon.removeClass("icon-expand"),icon.addClass("icon-contract"),void(c.state.isExpanding=!1)):(c.view.hasClass("medium-8")&&(c.view.addClass("large-4"),c.state.isExpanding=!0),c.view.addClass("medium-8"),void(c.state.isExpanding?(icon.addClass("icon-expand"),icon.removeClass("icon-contract")):(icon.removeClass("icon-expand"),icon.addClass("icon-contract"))))},Controller.prototype.destroyView=function(e,c){e.preventDefault(),c.controller.viewCount--,c.controller.singleView=1===c.controller.viewCount,c.view.remove()},Controller.prototype.nextChapter=function(e,c){e.preventDefault(),c.state.chapter>=c.state.chapters.length?(c.state.chapter=1,c.state.book++):c.state.chapter++,c.controller.changeChapter(e,c)},Controller.prototype.__buildContext=function(view){var context={view:view,controller:this,state:{isLoading:!0,isExpanding:!0,isLastChapter:!1,edition:"",book:1,chapter:1,books:[],chapters:[],title:null,content:null}};return context},Controller.prototype.__getView=function(){return template.clone()},module.define("Controller",Controller)}),function(){"use strict";var DEBUG=!1;module.define("debug",{log:function(obj){DEBUG&&console.log(obj)}})}(),module.require(["debug"],function(debug){"use strict";var BasicFetcher;BasicFetcher=function(){},BasicFetcher.prototype={getChapter:function(editionAPI,bookNum,chapterNum){var range=this.__getRangeID(bookNum,chapterNum),url=editionAPI+"html/"+range;return this.__makeRequest(url).then(function(d){return d.ranges[Object.keys(d.ranges)[0]]})},listBooks:function(editionAPI){return this.__makeRequest(editionAPI).then(function(data){var book,num,books=[];for(num in data.editionData.books)data.editionData.books.hasOwnProperty(num)&&(book=data.editionData.books[num],book.bookNum=parseInt(num,10),book.chapterCount=parseInt(book.chapterCount,10),books.push(book));return books})},listLanguages:function(){return this.__makeRequest("http://www.jw.org/en/publications/bible/json/").then(function(data){var langs=_.map(data.langs,function(lang){return lang.editions=_.filter(lang.editions,function(edition){return edition.contentAPI&&edition.contentAPI.length>0}),lang});return langs=_.filter(langs,function(lang){return lang.editions.length>0}),_.sortBy(langs,function(lang){return lang.lang.vernacularName})})},__getRangeID:function(bookNum,chapterNum){var range;return bookNum=bookNum||1,chapterNum=chapterNum||1,range=("00"+bookNum).slice(-2)+("00"+chapterNum).slice(-3),range+"001-"+range+"999"},__makeRequest:function(){var cache={};return function(path){return path+="?callback=?",cache.hasOwnProperty(path)||(debug.log("Requesting "+path),cache[path]=$.getJSON(path),cache[path].done(function(){debug.log("Response "+path)})),cache[path]}}()},module.define("fetcher",function(){return new BasicFetcher}())}),function(){"use strict";$.get("template.html").then(function(html){html=$(html),module.define("template",html)})}();