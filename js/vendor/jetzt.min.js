!function(){function elem(tagName,className,kids){var result=document.createElement(tagName);return result.className=className||"",kids&&kids.forEach(function(kid){result.appendChild(kid)}),result}function div(className,kids){return elem("div",className,kids)}function span(className,kids){return elem("span",className,kids)}function flatten(arr){var result=[],flat=function flat(thing){"[object Array]"===Object.prototype.toString.call(thing)?thing.forEach(flat):result.push(thing)};return flat(arr),result}function clamp(min,num,max){return Math.min(Math.max(num,min),max)}function maxModifier(a,b){return(modifiers[a]||1)>(modifiers[b]||1)?a:b}function wordShouldBeSplitUp(word){return word.length>13||word.length>9&&word.indexOf("-")>-1}function _maybeSplitLongWord(word){if(wordShouldBeSplitUp(word)){var result=[],dashIdx=word.indexOf("-");if(dashIdx>0&&dashIdx<word.length-1)return result.push(word.substr(0,dashIdx)),result.push(word.substr(dashIdx+1)),flatten(result.map(_maybeSplitLongWord));for(var partitions=Math.ceil(word.length/8),partitionLength=Math.ceil(word.length/partitions);partitions--;)result.push(word.substr(0,partitionLength)),word=word.substr(partitionLength);return result}return[word]}function splitLongWord(word){var result=_maybeSplitLongWord(word);if(result.length>1)for(var i=0;i<result.length-1;i++)result[i]+="-";return result}function parseText(text){for(var tokens=text.match(/["“”\(\)\/–—]|--+|\n+|[^\s"“”\(\)\/–—]+/g),instructions=[],modifier="start_paragraph",ignored=null,ignoreNext=function(){ignored=modifier,modifier="normal"},modNext=function(mod){modifier=maxModifier(modifier,mod)},modPrev=function(mod){if(instructions.length>0){var current=instructions[instructions.length-1].modifier;instructions[instructions.length-1].modifier=maxModifier(current,mod)}},leftWrap="",rightWrap="",pushWrap=function(wrap){leftWrap+=wrap.left,rightWrap=wrap.right+rightWrap},popWrap=function(wrap){for(var left="";left!==wrap.left&&leftWrap.length>0;)left=leftWrap.substr(leftWrap.length-1),leftWrap=leftWrap.substr(0,leftWrap.length-1),rightWrap=rightWrap.substr(1)},clearWrap=function(){leftWrap="",rightWrap=""},emit=function(token){instructions.push({token:token,leftWrap:leftWrap,rightWrap:rightWrap,modifier:modifier}),ignored?(modifier=ignored,ignored=null):modifier="normal"},double_quote_state=!1,handle_tkn=function(tkn){wordShouldBeSplitUp(tkn)?splitLongWord(tkn).forEach(emit):emit(tkn)},spacer=function(){ignoreNext(),handle_tkn("   ")},i=0;i<tokens.length;i++){var tkn=tokens[i];switch(tkn){case"“":spacer(),pushWrap(wraps.double_quote),modNext("start_clause");break;case"”":popWrap(wraps.double_quote),modPrev("end_clause"),spacer();break;case'"':double_quote_state?(spacer(),popWrap(wraps.double_quote),modNext("start_clause")):(pushWrap(wraps.double_quote),modPrev("end_clause"),spacer()),double_quote_state=!double_quote_state;break;case"(":spacer(),pushWrap(wraps.parens),modNext("start_clause");break;case")":popWrap(wraps.parens),modPrev("end_clause"),spacer();break;default:tkn.match(/^(\/|--+|—|–)$/)?(modNext("start_clause"),handle_tkn(tkn),modNext("start_clause")):tkn.match(/[.?!…]+$/)?(modNext("end_sentence"),handle_tkn(tkn),modNext("start_sentence")):tkn.match(/[,;:]$/)?(modNext("end_clause"),handle_tkn(tkn),modNext("start_clause")):tkn.match(/\n+/)?(modPrev("end_paragraph"),spacer(),modNext("start_paragraph"),double_quote_state=!1,clearWrap()):tkn.match(/^".+$/)?(double_quote_state=!0,modNext("start_clause"),handle_tkn(tkn.substr(1))):handle_tkn(tkn)}}return instructions}function makeBlackout(){blackout=div("sr-blackout"),document.body.appendChild(blackout),blackout.offsetWidth,blackout.className="sr-blackout in"}function makeBox(){wordDiv=div("sr-word"),wpmDiv=div("sr-wpm"),reticle=div("sr-reticle"),leftSpan=span(),rightSpan=span(),box=div("sr-reader",[div("sr-wrap sr-left",[leftSpan]),div("sr-word-box",[reticle,wordDiv,wpmDiv]),div("sr-wrap sr-right",[rightSpan])]),document.body.appendChild(box),box.offsetWidth,box.style.top="50%",adjustScale(0),adjustWPM(0)}function dismiss(){blackout.className="sr-blackout",box.style.top="-50%",window.setTimeout(function(){blackout.remove(),box.remove(),delete blackout,delete box,delete wordDiv,delete wpmSpan,delete leftSpan,delete rightSpan,delete reticle},340)}function adjustScale(diff){var current=config("scale"),adjusted=clamp(.1,current+diff,2);config("scale",adjusted),box.style.webkitTransform="translate(-50%, -50%) scale("+adjusted+")",box.style.mozTransform="translate(-50%, -50%) scale("+adjusted+")",box.style.transform="translate(-50%, -50%) scale("+adjusted+")"}function calculatePivot(word){var l=word.length;return 2>l?0:6>l?1:10>l?2:14>l?3:4}function setWord(word){var pivot=calculatePivot(word);wordDiv.innerHTML=word.substr(0,pivot)+"<span class='sr-pivot'>"+word.substr(pivot,1)+"</span>"+word.substr(pivot+1),wordDiv.offsetWidth;var pivotElem=wordDiv.getElementsByClassName("sr-pivot")[0],pivotCenter=reticle.offsetLeft+reticle.offsetWidth/2;wordDiv.style.left=pivotCenter-pivotElem.offsetLeft-pivotElem.offsetWidth/2+"px"}function adjustWPM(diff){var current=config("target_wpm"),adjusted=clamp(100,current+diff,1500);config("target_wpm",adjusted),wpmDiv.innerHTML=adjusted+""}function setWrap(left,right){left!==leftSpan.innerHTML&&(leftSpan.innerHTML=left,rightSpan.innerHTML=right)}function calculateDelay(instr){var interval=6e4/config("target_wpm");if("normal"!==instr.modifier)return interval*(modifiers[instr.modifier]||1);var len=instr.token.length,mul=1;switch(len){case 6:case 7:mul=1.2;break;case 8:case 9:mul=1.4;break;case 10:case 11:mul=1.8;break;case 12:case 13:mul=2}return interval*mul}function handleInstruction(instr){setWord(instr.token),setWrap(instr.leftWrap,instr.rightWrap),defer(calculateDelay(instr))}function defer(time){runLoop=setTimeout(function(){running&&index<instructions.length?handleInstruction(instructions[index++]):running=!1},time)}function toggleRunning(){running?(clearTimeout(runLoop),running=!1):(running=!0,defer(0))}function prevSentence(){for(index=Math.max(0,index-5);index>0&&!startModifiers[instructions[index].modifier];)index--;running||setWord(instructions[index].token)}function nextSentence(){for(index=Math.min(index+1,instructions.length-1);index<instructions.length-1&&!startModifiers[instructions[index].modifier];)index++;running||setWord(instructions[index].token)}function prevParagraph(){for(index=Math.max(0,index-5);index>0&&"start_paragraph"!=instructions[index].modifier;)index--;running||setWord(instructions[index].token)}function nextParagraph(){for(index=Math.min(index+1,instructions.length-1);index<instructions.length-1&&"start_paragraph"!=instructions[index].modifier;)index++;running||setWord(instructions[index].token)}function handleKeydown(ev){switch(ev.keyCode){case 27:ev.preventDefault(),close();break;case 38:ev.preventDefault(),adjustWPM(10);break;case 40:ev.preventDefault(),adjustWPM(-10);break;case 37:ev.preventDefault(),ev.altKey?prevParagraph():prevSentence();break;case 39:ev.preventDefault(),ev.altKey?nextParagraph():nextSentence();break;case 32:ev.preventDefault(),index==instructions.length&&(index=0),toggleRunning();break;case 107:case 187:ev.preventDefault(),adjustScale(.1);break;case 109:case 189:ev.preventDefault(),adjustScale(-.1)}}function init(text){makeBlackout(),makeBox(),blackout.onclick=close,instructions=parseText(text),index=0,existingOnKeyDown=window.onkeydown,window.onkeydown=handleKeydown,setTimeout(toggleRunning,500)}var running,instructions,index,runLoop,blackout,box,wordDiv,wpmSpan,leftSpan,rightSpan,reticle,existingOnKeyDown,config=function(){var storageEnabled=function(){return!(!window.chrome||!chrome.storage)},default_options={clause_pause_multiplier:.5,sentence_pause_multiplier:1,target_wpm:400,scale:1},options=default_options;return storageEnabled()&&chrome.storage.local.get(default_options,function(value){options=value}),function(key,val){if("undefined"==typeof val){if(options.hasOwnProperty(key))return options[key];throw new Error("bad key: "+key)}if(!options.hasOwnProperty(key)||typeof val!=typeof options[key])throw new Error("bad key/val: "+key+": "+val);options[key]=val,storageEnabled()&&chrome.storage.local.set(options)}}(),modifiers={normal:1,start_clause:1.5,end_clause:1.8,start_sentence:1.8,end_sentence:2.4,start_paragraph:2.2,end_paragraph:3},wraps={double_quote:{left:"“",right:"”"},parens:{left:"(",right:")"}},startModifiers={start_sentence:!0,start_paragraph:!0},close=function(){running&&toggleRunning(),dismiss(),instructions=null,window.onkeydown=existingOnKeyDown};window.addEventListener("keydown",function(ev){if(!instructions&&ev.altKey&&82===ev.keyCode){ev.preventDefault();var text=window.getSelection().toString();text.trim().length>0&&init(text)}})}();