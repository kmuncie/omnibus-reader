!function(){"use strict";function log(obj){DEBUG&&console.log(obj)}var Fetcher,Layout,View,Controller,DEBUG=!1,view_count=0;if(window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction,window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange,!window.indexedDB)return void window.alert("Your browser doesn't support a stable version of IndexedDB. Please upgrade to a modern browser.");Fetcher=function(){var gettingDB=new $.Deferred,request=window.indexedDB.open(this.DATABASE,this.VERSION);request.onerror=function(event){gettingDB.reject(),window.alert("Could not open IndexedDB connection. Error: "+event.target.errorCode)},request.onsuccess=function(){gettingDB.resolve(request.result)},request.onupgradeneeded=function(event){var db=event.target.result,bookStore=db.createObjectStore("books",{keyPath:"bookNum"}),chapterStore=db.createObjectStore("chapters",{keyPath:"range"});bookStore.createIndex("urlSegment","urlSegment",{unique:!0}),chapterStore.createIndex("validRange","validRange",{unique:!0})},this.gettingDB=gettingDB},Fetcher.prototype={DATABASE:"BibleFetcher",VERSION:1,BASE_URL:"http://www.jw.org/en/publications/bible/nwt/books/json/",fillCache:function(){var self=this;this.listBooks().then(function(books){!function load(i,j){var book=books[i],numChapters=parseInt(book.chapterCount,10);self.getChapter(book.bookNum,j).then(function(){numChapters>j?j++:(i++,j=1),i<books.length&&setTimeout(function(){load(i,j)},50)})}(0,1)})},getChapter:function(bid,cid){var range=this.__getRangeID(bid,cid),getting=new $.Deferred,self=this;return this.__getByKey("chapters",range).done(function(chapter){getting.resolve(chapter)}).fail(function(){self.__fillChapter(range).then(function(){return self.getChapter(bid,cid)}).then(function(chapter){getting.resolve(chapter)})}),getting},listBooks:function(){var listing=this.__listObjectStore("books"),self=this;return listing=listing.then(function(books){return 0===books.length?self.__fillBookStore().then(function(){return self.listBooks()}):books})},__fillBookStore:function(){var listing,self=this;return listing=this.__makeRequest("").then(function(data){return data.editionData.books}),listing.then(function(books){var bookNums=Object.keys(books);!function insert(bookNum){var book=books[bookNum];book.bookNum=parseInt(bookNum,10),self.__insert("books",book).then(function(){bookNums.length&&insert(bookNums.shift())})}(bookNums.shift())})},__fillChapter:function(range){var url="html/"+range,self=this;return this.__makeRequest(url).then(function(d){var chapter=d.ranges[Object.keys(d.ranges)[0]];return chapter.range=range,self.__insert("chapters",chapter)})},__getByKey:function(name,key){var getting=new $.Deferred;return this.__getObjectStore(name).then(function(store){var request=store.get(key);request.onsuccess=function(e){var result=e.target.result;return void 0!==result?(log("Found key "+key+" in "+name+" ObjectStore"),void getting.resolve(e.target.result)):(log("Found nothing for key "+key+" in "+name+" ObjectStore"),void getting.reject())}}),getting},__getObjectStore:function(name){return this.gettingDB.then(function(db){var transaction=db.transaction([name],"readwrite"),store=transaction.objectStore(name);return store})},__getRangeID:function(bid,cid){var bcid=("00"+bid).slice(-2)+("00"+cid).slice(-3),range=bcid+"001-"+bcid+"999";return range},__insert:function(name,obj){return this.__getObjectStore(name).then(function(store){store.add(obj)})},__listObjectStore:function(name,keyRange){var listing=new $.Deferred;return keyRange=keyRange||window.IDBKeyRange.lowerBound(0),this.__getObjectStore(name).then(function(store){var cursorRequest=store.openCursor(keyRange),set=[];cursorRequest.onsuccess=function(e){var cursor=e.target.result;return cursor?(set.push(cursor.value),void cursor.continue()):(log("Found "+set.length+" rows in "+name+" ObjectStore"),void listing.resolve(set))}}),listing},__makeRequest:function(){var cache={};return function(path){return path=this.BASE_URL+path+"?callback=?",cache.hasOwnProperty(path)||(log("Requesting "+path),cache[path]=$.getJSON(path),cache[path].done(function(){log("Response "+path)})),cache[path]}}()},Layout=function(){var divContent=$("#content"),divAddNew=$("#addNew");this.bindEvents=function(events){divAddNew.click(function(){events.layoutAddView()})},this.addView=function(view){divContent.append(view.divView)},this.removeView=function(view){view.divView.remove()}},View=function(){this.id=++view_count;var divTemplate=$("#template").children();this.divView=divTemplate.clone(),this.selectBooks=this.divView.find(".sel-book"),this.selectChapter=this.divView.find(".sel-chapter"),this.divLoading=this.divView.find(".loading"),this.divVerses=this.divView.find(".verses"),this.viewTitle=this.divView.find(".viewTitle"),this.buttonContrast=this.divView.find(".viewContrast"),this.textContrast=this.divView.find(".text-section"),this.buttonExpand=this.divView.find(".viewExpand"),this.iconResize=this.divView.find(".iconResize"),this.buttonClose=this.divView.find(".viewDestroy")},View.prototype={bindEvents:function(events){var self=this,isExpanding=!1;this.selectBooks.change(function(){var bid=self.selectBooks.val();events.viewSelectBook(self,bid)}),this.buttonContrast.click(function(){self.textContrast.toggleClass("darkMode")}),this.buttonExpand.click(function(){return self.divView.hasClass("medium-8 large-4")?void self.divView.removeClass("large-4"):self.divView.hasClass("medium-8")&&isExpanding?(self.divView.removeClass("medium-8"),void(isExpanding=!1)):(self.divView.hasClass("medium-8")&&(self.divView.addClass("large-4"),isExpanding=!0),self.divView.addClass("medium-8"),void(isExpanding&&(self.iconResize.removeClass("icon-contract"),self.iconResize.addClass("icon-expand"))))}),this.buttonClose.click(function(){events.viewDestroy(self)}),this.selectChapter.change(function(){var bid=self.selectBooks.val(),cid=self.selectChapter.val();events.viewSelectChapter(self,bid,cid)})},populateBookList:function(books){var book,i;for(this.selectBooks.empty(),i=0;i<books.length;i++)book=books[i],this.selectBooks.append('<option value="'+book.bookNum+'">'+book.standardAbbreviation+"</option>")},populateChapterList:function(lastChapter){this.selectChapter.empty();for(var i=1;lastChapter>i;i++)this.selectChapter.append('<option value="'+i+'">'+i+"</option>")},showChapter:function(chapter){this.divVerses.html(chapter.html),this.viewTitle.html(chapter.citation)},setLoadingIndicator:function(visible){return visible?void this.divLoading.fadeIn():void this.divLoading.fadeOut()},destroyView:function(){this.divView.fadeOut()}},Controller=function(layout,fetcher){var booklist,views=[],gettingBooks=fetcher.listBooks().done(function(books){booklist=books});this.ready=function(fn){gettingBooks.done(fn)};var events={layoutAddView:function(){var view=new View;views.push(view),view.populateBookList(booklist),events.viewSelectBook(view,1,1),view.bindEvents(events),layout.addView(view)},viewDestroy:function(view){layout.removeView(view),delete views[views.indexOf(view)]},viewSelectBook:function(view,bid,cid){bid=parseInt(bid,10),cid=parseInt(cid,10);var book=booklist.filter(function(b){return b.bookNum===bid})[0];view.populateChapterList(book.chapterCount),events.viewSelectChapter(view,bid,cid||1)},viewSelectChapter:function(view,bid,cid){bid=parseInt(bid,10),cid=parseInt(cid,10),view.setLoadingIndicator(!0),fetcher.getChapter(bid,cid).done(function(chapter){view.showChapter(chapter),view.setLoadingIndicator(!1)})}};layout.bindEvents(events),this.layoutAddView=events.layoutAddView};var layout=new Layout,fetcher=new Fetcher,controller=new Controller(layout,fetcher);controller.ready(function(){controller.layoutAddView(),controller.layoutAddView(),fetcher.fillCache()})}();